<!doctype html>
<html>
<head><meta charset="utf-8"><title>Admin - Medicines</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="../style.css"></head>
<body>
  <header class="topbar">
    <div class="brand small"><img src="../assets/logo.png" class="logo"><h1>MediKart (Admin)</h1></div>
    <nav>
      <a href="users.html" class="btn ghost">Users</a>
      <a href="orders.html" class="btn ghost">Orders</a>
      <a href="payments.html" class="btn ghost">Payments</a>
      <button onclick="logout()" class="btn">Logout</button>
    </nav>
  </header>

  <main class="container">
    <section style="display:flex;gap:16px;align-items:flex-start">
      <div style="flex:1">
        <h2>Medicines</h2>
        <div id="meds" class="grid"></div>
      </div>

      <aside style="width:360px">
        <div class="card">
          <h3>Add Medicine</h3>
          <form id="addMed">
            <label>Name<input name="name" required></label>
            <label>Description<input name="description" required></label>
            <label>Price<input name="price" type="number" step="0.01" required></label>
            <label>Stock<input name="stock" type="number" required></label>
            <label>Manufacturer<input name="manufacturer"></label>
            <label>Expiry Date<input name="expiryDate" type="date" required></label>
            <div style="margin-top:10px">
              <button class="btn" type="submit">Add</button>
              <button type="button" class="btn ghost" onclick="removeExpired()">Remove expired</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Reports</h3>
          <div class="kicker">Low-stock medicines</div>
          <div id="lowStock"></div>
          <div style="margin-top:8px"><button class="btn ghost" onclick="loadExpired()">Show expired</button></div>
          <div id="expiredList" style="margin-top:8px"></div>
        </div>
      </aside>
    </section>
  </main>

<script src="../api.js"></script>
<script src="../utils.js"></script>
<script>
  if (!requireAuth(['ROLE_ADMIN'])) throw new Error('Not authorized');

  async function loadAll(){
    try {
      const meds = await GET('/admin/medicines');
      document.getElementById('meds').innerHTML = meds.map(m => `
        <div class="medicine-card">
          <h3>${m.name}</h3>
          <div class="kicker">₹ ${m.price?.toFixed(2)} • Stock ${m.stock}</div>
          <div class="meta">${m.description}</div>
          <div class="kicker">Expiry: ${fmtDate(m.expiryDate)} • By: ${m.manufacturer}</div>
        </div>
      `).join('');
      const low = await GET('/admin/medicines/low-stock');
      document.getElementById('lowStock').innerHTML = low.length ? low.map(x=>`<div class="faint">${x.name} (${x.stock})</div>`).join('') : '<div class="faint">None</div>';
    } catch (e) { alert('Load error: ' + e.message); }
  }

  document.getElementById('addMed').addEventListener('submit', async function(e){
    e.preventDefault();
    const fd = new FormData(this);
    const dto = {
      name: fd.get('name'),
      description: fd.get('description'),
      price: parseFloat(fd.get('price')),
      stock: parseInt(fd.get('stock')),
      manufacturer: fd.get('manufacturer'),
      expiryDate: fd.get('expiryDate')
    };
    try {
      await POST('/admin/addmedicine', dto);
      alert('Added');
      loadAll();
      this.reset();
    } catch (err) { alert('Add failed: ' + err.message); }
  });

  async function removeExpired(){
    if(!confirm('Remove all expired medicines?')) return;
    try {
      const res = await DELETE('/admin/medicines/remove-expired');
      alert(res);
      loadAll();
    } catch (e) { alert('Remove failed: ' + e.message); }
  }

  async function loadExpired(){
    try {
      const exp = await GET('/admin/medicines/expired');
      document.getElementById('expiredList').innerHTML = exp.length ? exp.map(x=>`<div class="faint">${x.name} • Expiry: ${fmtDate(x.expiryDate)}</div>`).join('') : '<div class="faint">No expired</div>';
    } catch (e) { alert('Failed: ' + e.message); }
  }

  loadAll();
</script>
</body>
</html>
